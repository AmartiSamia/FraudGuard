@startuml FraudGuard_Sequence
!define ABSTRACT abstract

skinparam backgroundColor #1a1a1a
skinparam defaultFontColor #FFFFFF
skinparam sequenceActorBackgroundColor #4a6a8a
skinparam sequenceParticipantBackgroundColor #2a4a6a
skinparam sequenceArrowColor #FFFFFF
skinparam sequenceGroupBackgroundColor #3a5a7a

title FraudGuard - Transaction Fraud Detection Sequence

actor "üë§ Customer" as customer
participant "üåê Browser\n(Angular)" as browser
participant "üî∑ API\n(ASP.NET)" as api
participant "üî¥ Redis\nCache" as redis
participant "üóÑÔ∏è Database\n(SQL Server)" as db
participant "‚öôÔ∏è Kafka\nBroker" as kafka
participant "üêç ML Service\n(XGBoost)" as ml
participant "üìà Prometheus\nMetrics" as prometheus
participant "üìâ Grafana\nDashboard" as grafana

autonumber

== 1Ô∏è‚É£  User Login & Authentication ==
customer -> browser: Opens app
activate browser
browser -> api: GET /login
activate api
api -> redis: Check user cache
activate redis
alt User in cache
    redis --> api: User data (cached)
    deactivate redis
else User not in cache
    redis --> api: Cache miss
    deactivate redis
    api -> db: SELECT * FROM Users
    activate db
    db --> api: User data
    deactivate db
    api -> redis: SET user:{id}
    activate redis
    redis --> api: Cached
    deactivate redis
end
api --> browser: Auth token
deactivate api
browser --> customer: Login successful
deactivate browser

== 2Ô∏è‚É£  User Initiates Transaction ==
customer -> browser: Submit transaction\n(Amount: $500, Merchant: Amazon)
activate browser
browser -> api: POST /transactions\n{amount, merchant, device, location}
activate api

== 3Ô∏è‚É£  API Validates & Enriches Transaction ==
api -> api: Validate input (amount, merchant)
api -> redis: GET user history
activate redis
redis --> api: Recent transactions
deactivate redis
api -> db: SELECT recent_transactions
activate db
db --> api: Last 10 transactions
deactivate db

== 4Ô∏è‚É£  Save Transaction to Database ==
api -> db: INSERT INTO Transactions
activate db
db --> api: Transaction ID: TXN-12345
deactivate db
api --> browser: Transaction received
deactivate browser

== 5Ô∏è‚É£  Publish to Kafka for ML Processing ==
api -> kafka: PUBLISH to topic: fraudguard-transactions\n{id, amount, merchant, user_id, device, location, timestamp}
activate kafka
kafka -> kafka: Store in partition
deactivate kafka

== 6Ô∏è‚É£  ML Service Subscribes & Analyzes ==
kafka --> ml: SUBSCRIBE fraudguard-transactions
activate ml
ml -> ml: Extract features (20+ features)
note over ml
  Features analyzed:
  - Amount
  - Location (user normal area?)
  - Device (known device?)
  - Time of day (user's active hours?)
  - Merchant (user shops here before?)
  - Card used (primary/backup?)
  - Login location (same as trans?)
  - Velocity (# trans in last hour?)
  - User history (avg spend?)
  - Risk score (baseline)
  - And 10+ more...
end note
ml -> ml: Load XGBoost model
ml -> ml: PREDICT fraud probability\n(0.0 - 1.0 scale)
note over ml
  ‚úÖ Model Accuracy: 98%
  ‚è±Ô∏è  Inference Time: <50ms
  üéØ Confidence: High
  Result: 0.15 (15% fraud probability)
  Decision: LOW RISK - APPROVE
end note

== 7Ô∏è‚É£  ML Publishes Result to Kafka ==
ml -> kafka: PUBLISH to topic: fraudguard-fraud-alerts\n{transaction_id, fraud_score, confidence, decision, timestamp}
activate kafka
kafka -> kafka: Store result
deactivate kafka
deactivate ml

== 8Ô∏è‚É£  API Subscribes to Results ==
kafka --> api: SUBSCRIBE fraudguard-fraud-alerts
activate api
api -> api: Receive fraud prediction (0.15)
api -> api: Create FraudAlert record\nDecision: APPROVED

== 9Ô∏è‚É£  Save Alert to Database ==
api -> db: INSERT INTO FraudAlerts\n{transaction_id, fraud_score, decision, analyst_review_required}
activate db
db --> api: Alert ID: ALERT-67890
deactivate db

== üîü  Cache Alert Result ==
api -> redis: SET fraud_alert:{txn_id}\n{fraud_score, decision, timestamp}
activate redis
redis --> api: Cached (5 min TTL)
deactivate redis

== 1Ô∏è‚É£1Ô∏è‚É£  Publish Audit Log ==
api -> kafka: PUBLISH to topic: fraudguard-audit-log\n{transaction_id, decision, fraud_score, analyst_action, timestamp}
activate kafka
kafka -> kafka: Store audit log
deactivate kafka

== 1Ô∏è‚É£2Ô∏è‚É£  Send Response to Customer ==
api --> browser: Transaction approved
activate browser
browser --> customer: ‚úÖ Transaction successful!\nAmount: $500, Merchant: Amazon
deactivate browser
deactivate api

== 1Ô∏è‚É£3Ô∏è‚É£  Collect Metrics ==
api -> prometheus: http_requests_total++
api -> prometheus: http_request_duration_seconds = 85ms
api -> prometheus: fraud_detection_accuracy = 0.98
ml -> prometheus: ml_inference_latency = 45ms
redis -> prometheus: cache_hits_total++
kafka -> prometheus: kafka_messages_published++
activate prometheus
prometheus -> prometheus: Store metrics (15s interval)
deactivate prometheus

== 1Ô∏è‚É£4Ô∏è‚É£  Grafana Updates Dashboards ==
prometheus --> grafana: Push metrics
activate grafana
grafana -> grafana: Update charts
note over grafana
  üìä Dashboard Updated:
  - Request count: ‚Üë1
  - Response time: 85ms
  - Cache hit: Yes
  - Fraud score: 0.15
  - Status: ‚úÖ APPROVED
  
  üî¥ High Risk Transactions: 0
  üü† Medium Risk: 2
  üü¢ Low Risk: 45
  
  üìà Accuracy: 98%
  ‚ö° Throughput: 120 txn/sec
end note
deactivate grafana

== 1Ô∏è‚É£5Ô∏è‚É£  Analyst Dashboard (Real-Time) ==
analyst -> browser: View Grafana dashboard
activate browser
note over browser
  üîç Alert Summary:
  ‚Ä¢ Total Transactions: 1,200
  ‚Ä¢ Fraud Detected: 8 (0.67%)
  ‚Ä¢ Approved: 1,182
  ‚Ä¢ Pending Review: 10
  
  ‚ö†Ô∏è Highest Risk:
  1. $10K China -> USA (95% fraud)
  2. $5K new device (78% fraud)
  3. $3K velocity spike (65% fraud)
end note
deactivate browser

@enduml
