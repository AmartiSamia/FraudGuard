<div class="user-management">
  <div class="page-header">
    <div class="header-content">
      <h1>
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="header-icon">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/>
        </svg>
        Gestion des Utilisateurs
      </h1>
      <p>GÃ©rez les utilisateurs, crÃ©ez des comptes et contrÃ´lez les accÃ¨s</p>
    </div>
    <button class="btn btn-primary" (click)="openCreateModal()">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/>
      </svg>
      Ajouter un Utilisateur
    </button>
  </div>

  <!-- Alerts -->
  <div class="alert alert-success" *ngIf="success">
    {{ success }}
  </div>
  <div class="alert alert-danger" *ngIf="error">
    {{ error }}
    <button class="close-btn" (click)="error = ''">&times;</button>
  </div>

  <!-- Filters -->
  <div class="filters-bar">
    <div class="search-box">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
      </svg>
      <input 
        type="text" 
        [(ngModel)]="searchQuery" 
        placeholder="Rechercher par nom ou email..."
        (keyup.enter)="onSearch()"
      >
    </div>
    <div class="filter-group">
      <select [(ngModel)]="roleFilter" (change)="onFilterChange()">
        <option value="">Tous les RÃ´les</option>
        <option value="Admin">Administrateur</option>
        <option value="User">Utilisateur</option>
      </select>
    </div>
    <button class="btn btn-secondary" (click)="onSearch()">
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/>
      </svg>
      Filtrer
    </button>
  </div>

  <!-- Users Table -->
  <div class="table-container">
    <div class="loading-overlay" *ngIf="loading">
      <div class="spinner"></div>
    </div>

    <table class="data-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Utilisateur</th>
          <th>Email</th>
          <th>RÃ´le</th>
          <th>Comptes</th>
          <th>Transactions</th>
          <th>CrÃ©Ã© le</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let user of users">
          <td class="id-cell">#{{ user.id }}</td>
          <td class="name-cell">
            <div class="user-avatar">{{ user.firstName.charAt(0) }}{{ user.lastName.charAt(0) }}</div>
            <span>{{ user.firstName }} {{ user.lastName }}</span>
          </td>
          <td>{{ user.email }}</td>
          <td>
            <span class="badge" [ngClass]="getRoleBadgeClass(user.role)">
              <svg *ngIf="user.role === 'Admin'" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="currentColor">
                <path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/>
              </svg>
              <svg *ngIf="user.role !== 'Admin'" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
              </svg>
              {{ user.role }}
            </span>
          </td>
          <td>{{ user.accountCount || 0 }}</td>
          <td>{{ user.transactionCount || 0 }}</td>
          <td>{{ user.createdAt | date:'dd/MM/yyyy' }}</td>
          <td class="actions-cell">
            <div class="actions-dropdown">
              <button class="btn-actions" (click)="toggleActionsDropdown($event, user.id)" title="Actions">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/>
                </svg>
              </button>
              <div class="dropdown-menu" *ngIf="showActionsDropdown === user.id">
                <button class="dropdown-item" (click)="viewUserDetail(user)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>
                  </svg>
                  Voir les DÃ©tails
                </button>
                <button class="dropdown-item" (click)="openEditModal(user)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                  </svg>
                  Modifier
                </button>
                <div class="dropdown-divider"></div>
                <button class="dropdown-item" *ngIf="user.role === 'User'" (click)="promoteToAdmin(user)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="18 15 12 9 6 15"/>
                  </svg>
                  Promouvoir Admin
                </button>
                <button class="dropdown-item" *ngIf="user.role === 'Admin'" (click)="demoteToUser(user)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="6 9 12 15 18 9"/>
                  </svg>
                  RÃ©trograder User
                </button>
                <button class="dropdown-item" (click)="openAccountModal(user)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/>
                  </svg>
                  GÃ©rer Comptes
                </button>
                <div class="dropdown-divider"></div>
                <button class="dropdown-item danger" (click)="openDeleteModal(user)">
                  <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                  </svg>
                  Supprimer
                </button>
              </div>
            </div>
          </td>
        </tr>
        <tr *ngIf="users.length === 0 && !loading">
          <td colspan="8" class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="23" y1="11" x2="17" y2="11"/>
            </svg>
            <p>Aucun utilisateur trouvÃ©</p>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
  <div class="pagination" *ngIf="totalPages > 1">
    <button 
      class="page-btn" 
      [disabled]="currentPage === 1"
      (click)="goToPage(currentPage - 1)"
    >
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="15 18 9 12 15 6"/>
      </svg>
    </button>
    <span class="page-info">Page {{ currentPage }} sur {{ totalPages }}</span>
    <button 
      class="page-btn" 
      [disabled]="currentPage === totalPages"
      (click)="goToPage(currentPage + 1)"
    >
      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="9 18 15 12 9 6"/>
      </svg>
    </button>
    <span class="total-count">Total: {{ totalCount }} utilisateurs</span>
  </div>
</div>

<!-- Create User Modal -->
<div class="modal-overlay" *ngIf="showCreateModal" (click)="closeModals()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>CrÃ©er un Nouvel Utilisateur</h2>
      <button class="close-btn" (click)="closeModals()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label>PrÃ©nom</label>
          <input type="text" [(ngModel)]="newUser.firstName" placeholder="Entrez le prÃ©nom">
        </div>
        <div class="form-group">
          <label>Nom</label>
          <input type="text" [(ngModel)]="newUser.lastName" placeholder="Entrez le nom">
        </div>
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" [(ngModel)]="newUser.email" placeholder="Entrez l'adresse email">
      </div>
      <div class="form-group">
        <label>Mot de passe</label>
        <input type="password" [(ngModel)]="newUser.password" placeholder="Entrez le mot de passe">
      </div>
      <div class="form-group">
        <label>RÃ´le</label>
        <select [(ngModel)]="newUser.role">
          <option value="User">ğŸ‘¤ Utilisateur Standard</option>
          <option value="Admin">ğŸ‘‘ Administrateur</option>
        </select>
      </div>
      <div class="form-group checkbox-group">
        <label>
          <input type="checkbox" [(ngModel)]="newUser.createDefaultAccount">
          CrÃ©er un compte bancaire par dÃ©faut
        </label>
      </div>
      <div class="form-group" *ngIf="newUser.createDefaultAccount">
        <label>Solde Initial (MAD)</label>
        <input type="number" [(ngModel)]="newUser.initialBalance" placeholder="1000">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeModals()">Annuler</button>
      <button class="btn btn-primary" (click)="createUser()" [disabled]="loading">
        â• CrÃ©er l'Utilisateur
      </button>
    </div>
  </div>
</div>

<!-- Edit User Modal -->
<div class="modal-overlay" *ngIf="showEditModal" (click)="closeModals()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>âœï¸ Modifier l'Utilisateur</h2>
      <button class="close-btn" (click)="closeModals()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <div class="form-group">
          <label>PrÃ©nom</label>
          <input type="text" [(ngModel)]="editForm.firstName">
        </div>
        <div class="form-group">
          <label>Nom</label>
          <input type="text" [(ngModel)]="editForm.lastName">
        </div>
      </div>
      <div class="form-group">
        <label>Email</label>
        <input type="email" [(ngModel)]="editForm.email">
      </div>
      <div class="form-group">
        <label>RÃ´le</label>
        <select [(ngModel)]="editForm.role">
          <option value="User">ğŸ‘¤ Utilisateur Standard</option>
          <option value="Admin">ğŸ‘‘ Administrateur</option>
        </select>
      </div>
      <div class="form-group">
        <label>Nouveau Mot de passe (laisser vide pour conserver l'actuel)</label>
        <input type="password" [(ngModel)]="editForm.password" placeholder="Entrez un nouveau mot de passe">
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeModals()">Annuler</button>
      <button class="btn btn-primary" (click)="updateUser()" [disabled]="loading">
        ğŸ’¾ Enregistrer les Modifications
      </button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" *ngIf="showDeleteModal" (click)="closeModals()">
  <div class="modal modal-small" (click)="$event.stopPropagation()">
    <div class="modal-header danger">
      <h2>âš ï¸ Confirmer la Suppression</h2>
      <button class="close-btn" (click)="closeModals()">&times;</button>
    </div>
    <div class="modal-body">
      <p class="warning-text">
        ÃŠtes-vous sÃ»r de vouloir supprimer <strong>{{ userToDelete?.firstName }} {{ userToDelete?.lastName }}</strong>?
      </p>
      <p class="warning-detail">Cette action supprimera Ã©galement tous ses comptes, transactions et donnÃ©es associÃ©es. Cette action est irrÃ©versible.</p>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeModals()">Annuler</button>
      <button class="btn btn-danger" (click)="confirmDelete()" [disabled]="loading">
        ğŸ—‘ï¸ Supprimer l'Utilisateur
      </button>
    </div>
  </div>
</div>

<!-- User Detail Modal -->
<div class="modal-overlay" *ngIf="showDetailModal" (click)="closeModals()">
  <div class="modal modal-large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>ğŸ‘¤ DÃ©tails de l'Utilisateur</h2>
      <button class="close-btn" (click)="closeModals()">&times;</button>
    </div>
    <div class="modal-body" *ngIf="userDetail">
      <div class="user-detail-header">
        <div class="detail-avatar">{{ userDetail.user.firstName.charAt(0) }}{{ userDetail.user.lastName.charAt(0) }}</div>
        <div class="detail-info">
          <h3>{{ userDetail.user.firstName }} {{ userDetail.user.lastName }}</h3>
          <p>{{ userDetail.user.email }}</p>
          <span class="badge" [ngClass]="getRoleBadgeClass(userDetail.user.role)">
            {{ userDetail.user.role === 'Admin' ? 'ğŸ‘‘ Administrateur' : 'ğŸ‘¤ Utilisateur' }}
          </span>
        </div>
      </div>
      
      <div class="stats-grid">
        <div class="stat-box">
          <span class="stat-value">{{ userDetail.stats.totalTransactions }}</span>
          <span class="stat-label">Total Transactions</span>
        </div>
        <div class="stat-box fraud">
          <span class="stat-value">{{ userDetail.stats.fraudTransactions }}</span>
          <span class="stat-label">Transactions Suspectes</span>
        </div>
        <div class="stat-box">
          <span class="stat-value">{{ userDetail.stats.totalBalance | number:'1.2-2' }} MAD</span>
          <span class="stat-label">Solde Total</span>
        </div>
        <div class="stat-box">
          <span class="stat-value">{{ userDetail.stats.totalAmount | number:'1.2-2' }} MAD</span>
          <span class="stat-label">Volume Total</span>
        </div>
      </div>

      <div class="accounts-section" *ngIf="userDetail.user.accounts?.length">
        <h4>ğŸ’³ Comptes Bancaires</h4>
        <div class="accounts-list">
          <div class="account-item" *ngFor="let account of userDetail.user.accounts">
            <span class="account-number">{{ account.accountNumber }}</span>
            <span class="account-balance">{{ account.balance | number:'1.2-2' }} MAD</span>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeModals()">Fermer</button>
      <button class="btn btn-primary" (click)="openEditModal(userDetail?.user)" *ngIf="userDetail">
        âœï¸ Modifier
      </button>
    </div>
  </div>
</div>

<!-- Account Management Modal -->
<div class="modal-overlay" *ngIf="showAccountModal" (click)="closeModals()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>ğŸ’³ GÃ©rer les Comptes</h2>
      <button class="close-btn" (click)="closeModals()">&times;</button>
    </div>
    <div class="modal-body" *ngIf="selectedUserForAccount">
      <p class="info-text">
        Gestion des comptes pour <strong>{{ selectedUserForAccount.firstName }} {{ selectedUserForAccount.lastName }}</strong>
      </p>
      
      <div class="form-group">
        <label>CrÃ©er un nouveau compte bancaire</label>
        <div class="form-row">
          <input type="number" [(ngModel)]="newAccountBalance" placeholder="Solde initial" class="form-input">
          <button class="btn btn-primary">CrÃ©er le Compte</button>
        </div>
      </div>

      <div class="info-box">
        <p>ğŸ“Œ Les fonctionnalitÃ©s avancÃ©es de gestion des comptes seront disponibles dans une prochaine mise Ã  jour.</p>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeModals()">Fermer</button>
    </div>
  </div>
</div>
